{
  "branch": "billing-overhaul",
  "tests": [
    {
      "id": "billing-modal-opens-no-plan",
      "category": "Billing Modal",
      "description": "New user sees non-dismissible borderless billing modal after onboarding (no daemon modal behind it)",
      "steps": [
        "After onboarding completes, verify the billing plan modal opens automatically",
        "Verify the modal has no blue bounding box / border (borderless presentation)",
        "Verify clicking outside does NOT close the modal and no close (X) button is shown",
        "Verify the URL hash is NOT set to #daemons — daemon setup is suppressed until plan is selected",
        "Verify no daemon creation modal appears on top of or behind the billing modal",
        "Verify the Free plan is the leftmost column",
        "Toggle between Personal and Commercial — verify Free plan appears on both",
        "Scroll down in the billing plan grid — verify all feature rows are accessible",
        "Verify each plan shows its included Hosts count (row between Networks and features)"
      ],
      "expected": "Borderless billing modal, no daemon modal interference, Free plan leftmost, scrollable, Hosts row visible",
      "flow": "setup",
      "sequence": 1,
      "status": null,
      "feedback": null
    },
    {
      "id": "free-plan-checkout",
      "category": "Billing Modal",
      "description": "Selecting Free plan completes $0 Stripe checkout without requiring a card",
      "steps": [
        "In the billing modal, click 'Get Started' on the Free plan",
        "Verify redirect to Stripe checkout page",
        "Complete the $0 checkout — no credit card should be required",
        "Verify redirect back to the app",
        "Verify the billing modal is gone and the app is accessible"
      ],
      "expected": "Stripe checkout completes without payment method, user returns to app with Free plan active, modal dismissed",
      "flow": "setup",
      "sequence": 2,
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-offers-returning",
      "category": "Billing Modal",
      "description": "Trial badges hidden for orgs that have previously had a paid plan or trialed",
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans do NOT show trial day badges",
        "Verify CTA buttons say 'Get Started' (not 'Start Free Trial')"
      ],
      "setup": "Set org to a non-Free plan (simulating a returning customer): UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'active' WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "No trial offers shown to returning customers, buttons say 'Get Started'",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-offers-returning-trialed",
      "category": "Billing Modal",
      "description": "Trial badges hidden for orgs with trial_end_date set (even if on Free plan now)",
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans do NOT show trial day badges"
      ],
      "setup": "Set trial_end_date on the org while on Free plan: UPDATE organizations SET plan = '{\"type\":\"Free\",\"base_cents\":0,\"rate\":\"Month\",\"trial_days\":0,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":3,\"included_hosts\":25}', plan_status = 'active', trial_end_date = NOW() - INTERVAL '1 day' WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "No trial offers shown — org has previously trialed",
      "status": null,
      "feedback": null
    },
    {
      "id": "settings-billing-notification-dot",
      "category": "Settings",
      "description": "Billing notification dot shown only when trialing without payment, with payment card above current plan",
      "steps": [
        "Verify the sidebar Settings icon has an amber/yellow notification dot",
        "Open the Settings modal",
        "Verify the Billing tab label has an amber notification dot",
        "Verify the 'Add Payment Method' card appears ABOVE the Current Plan card",
        "Verify the 'Add Payment Method' card has a notification dot icon"
      ],
      "setup": "Set org to trialing status without a payment method: UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'trialing', has_payment_method = false, trial_end_date = NOW() + INTERVAL '5 days' WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "Amber notification dot on sidebar and billing tab, payment card above current plan with dot indicator",
      "status": null,
      "feedback": null
    },
    {
      "id": "notification-dot-not-shown-free",
      "category": "Settings",
      "description": "No notification dot shown for Free plan users (no action needed)",
      "steps": [
        "Verify the sidebar Settings icon does NOT have an amber notification dot",
        "Open the Settings modal",
        "Verify the Billing tab label does NOT have a notification dot"
      ],
      "setup": "Org should be on the Free plan with plan_status = 'active' (default state after setup flow).",
      "expected": "No notification dot — Free plan users have no pending action",
      "status": null,
      "feedback": null
    },
    {
      "id": "notification-dot-clears-after-downgrade",
      "category": "Settings",
      "description": "Notification dot clears when downgrading from trial to Free plan",
      "steps": [
        "Verify the sidebar Settings icon has an amber notification dot (from trialing state)",
        "Downgrade to Free plan via View Plans > Get Started on Free",
        "Complete Stripe checkout for Free plan",
        "After returning to the app, verify the notification dot is gone"
      ],
      "setup": "Set org to trialing without payment: UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'trialing', has_payment_method = false, trial_end_date = NOW() + INTERVAL '5 days' WHERE id = '<org_id>'. Refresh the browser.",
      "expected": "Notification dot disappears after downgrading to Free (no longer trialing)",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-mode-richselect-upgrade",
      "category": "Daemon Creation",
      "description": "Daemon mode dropdown: DaemonPoll upgrade tag is visually clickable, opens billing modal on top",
      "steps": [
        "Open the daemon creation modal",
        "Open the Mode dropdown",
        "Verify ServerPoll shows description text underneath the label",
        "Verify DaemonPoll shows a yellow 'Upgrade' tag and description text",
        "Verify DaemonPoll option is NOT heavily grayed out — it should look clickable (slight dim only)",
        "Click on the DaemonPoll option — verify the billing plan modal opens ON TOP of the daemon modal",
        "Close the billing plan modal and verify you're back on the daemon creation form"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one network exists.",
      "expected": "DaemonPoll has clickable appearance, billing modal opens on top of daemon modal, descriptions shown",
      "status": null,
      "feedback": null
    },
    {
      "id": "discovery-upgrade-tag-clickable",
      "category": "Discovery",
      "description": "Scheduled discovery upgrade tag is visually clickable, opens billing modal on top",
      "steps": [
        "Open the discovery creation modal",
        "Open the Run Type dropdown",
        "Verify the Scheduled option is NOT heavily grayed out — it should look clickable",
        "Click on the Scheduled option — verify the billing plan modal opens ON TOP of the discovery modal",
        "Close the billing plan modal and verify you're back on the discovery form"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one daemon exists.",
      "expected": "Scheduled option has clickable appearance, billing modal opens on top",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-to-free",
      "category": "Billing",
      "description": "Downgrade from paid plan to Free via Manage Subscription (Stripe portal)",
      "steps": [
        "Open Settings > Billing tab",
        "Verify current plan shows a paid plan (e.g., Starter)",
        "Click 'Manage Subscription' — verify redirect to Stripe customer portal",
        "In the portal, cancel the subscription",
        "Return to the app",
        "Open Settings > Billing tab — verify plan status reflects the cancellation"
      ],
      "setup": "Org should be on a paid plan with an active Stripe subscription.",
      "expected": "Stripe portal allows cancellation, app reflects canceled status after webhook processes",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-poll-free-plan-interaction",
      "category": "Daemon",
      "description": "Existing DaemonPoll daemon behavior when org is on Free plan",
      "steps": [
        "Verify the daemon list shows the existing DaemonPoll daemon",
        "Check daemon status — verify the daemon is shown but may not connect (Free plan does not include DaemonPoll)",
        "Open Settings > Billing > View Plans and upgrade to a paid plan",
        "After upgrading, verify the DaemonPoll daemon can now connect and function"
      ],
      "setup": "Create a DaemonPoll daemon while on a paid plan: 1) Set org to paid plan: UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'active' WHERE id = '<org_id>'. 2) Create a daemon with mode=daemon_poll. 3) Downgrade to Free plan: UPDATE organizations SET plan = '{\"type\":\"Free\",\"base_cents\":0,\"rate\":\"Month\",\"trial_days\":0,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":3,\"included_hosts\":25}', plan_status = 'active' WHERE id = '<org_id>'. Refresh browser.",
      "expected": "DaemonPoll daemon visible but limited on Free plan, functional again after upgrading",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-ending-email",
      "category": "Emails",
      "description": "Trial ending soon email is sent when trial is about to expire",
      "steps": [
        "Check email inbox for trial-ending notification",
        "Verify the email contains: plan name, days remaining, link to add payment method",
        "Click the link in the email — verify it opens the app's billing settings"
      ],
      "setup": "Set org to trialing with trial ending in 3 days: UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'trialing', trial_end_date = NOW() + INTERVAL '3 days', has_payment_method = false WHERE id = '<org_id>'. Trigger the trial notification check (may require waiting for cron or manual trigger).",
      "expected": "Email received with trial ending details and working link to billing settings",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-email",
      "category": "Emails",
      "description": "Email notification sent when subscription is canceled/downgraded",
      "steps": [
        "Check email inbox for downgrade/cancellation notification",
        "Verify the email mentions the plan change and any impact on features"
      ],
      "setup": "Cancel a paid subscription via Stripe portal (see downgrade-to-free test). Wait for webhook to process.",
      "expected": "Cancellation email received with plan change details",
      "status": null,
      "feedback": null
    }
  ]
}
