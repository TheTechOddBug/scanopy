{
  "branch": "billing-overhaul",
  "tests": [
    {
      "id": "billing-modal-opens-no-plan",
      "category": "Billing Modal",
      "description": "New user sees non-dismissible billing modal after onboarding (no header, Free leftmost, scrollable, shows hosts)",
      "steps": [
        "After onboarding completes, verify the billing plan modal opens automatically (full-screen, no header/title bar)",
        "Verify clicking outside does NOT close the modal and no close (X) button is shown",
        "Verify the daemon setup tab does NOT appear behind the billing modal",
        "Verify the Free plan is the leftmost column",
        "Toggle between Personal and Commercial — verify Free plan appears on both",
        "Scroll down in the billing plan grid — verify all feature rows are accessible",
        "Verify each plan shows its included Hosts count (row between Networks and features)"
      ],
      "expected": "Full-screen billing modal without header, Free plan leftmost on both toggles, cannot be dismissed, no daemon modal behind it, scrollable content, Hosts row visible",
      "flow": "setup",
      "sequence": 1,
      "status": null,
      "feedback": null
    },
    {
      "id": "free-plan-checkout",
      "category": "Billing Modal",
      "description": "Selecting Free plan completes $0 Stripe checkout without requiring a card",
      "steps": [
        "In the billing modal, click 'Get Started' on the Free plan",
        "Verify redirect to Stripe checkout page",
        "Complete the $0 checkout — no credit card should be required",
        "Verify redirect back to the app",
        "Verify the billing modal is gone and the app is accessible"
      ],
      "expected": "Stripe checkout completes without payment method, user returns to app with Free plan active, modal dismissed",
      "flow": "setup",
      "sequence": 2,
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-offers-first-time",
      "category": "Billing Modal",
      "description": "Trial badges shown for Free plan orgs and reflected during checkout",
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans show trial day badges (e.g., '7-day free trial')",
        "Click 'Start Free Trial' on a paid plan (e.g., Starter)",
        "On the Stripe checkout page, verify the trial is reflected (e.g., '$0.00 due today' or trial language)"
      ],
      "setup": "Org should be on the Free plan with no trial_end_date set (the default state after the setup flow).",
      "expected": "Trial badges visible on paid plans, and Stripe checkout shows trial pricing",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-offers-returning",
      "category": "Billing Modal",
      "description": "Trial badges hidden for orgs that have previously had a paid plan or trialed",
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans do NOT show trial day badges",
        "Verify CTA buttons say 'Get Started' (not 'Start Free Trial')"
      ],
      "setup": "Set org to a non-Free plan (simulating a returning customer): UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'active' WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "No trial offers shown to returning customers, buttons say 'Get Started'",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-offers-returning-trialed",
      "category": "Billing Modal",
      "description": "Trial badges hidden for orgs with trial_end_date set (even if on Free plan now)",
      "steps": [
        "Open Settings > Billing tab",
        "Click 'View Plans'",
        "Verify paid plans do NOT show trial day badges"
      ],
      "setup": "Set trial_end_date on the org while on Free plan: UPDATE organizations SET plan = '{\"type\":\"Free\",\"base_cents\":0,\"rate\":\"Month\",\"trial_days\":0,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":3,\"included_hosts\":25}', plan_status = 'active', trial_end_date = NOW() - INTERVAL '1 day' WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "No trial offers shown — org has previously trialed",
      "status": null,
      "feedback": null
    },
    {
      "id": "settings-billing-notification-dot",
      "category": "Settings",
      "description": "Billing tab shows amber notification dot when trialing without payment method",
      "steps": [
        "Open the Settings modal",
        "Verify the Billing tab label has an amber/yellow notification dot (matching the sidebar dot color)"
      ],
      "setup": "Set org to trialing status without a payment method: UPDATE organizations SET plan_status = 'trialing', has_payment_method = false WHERE id = '<org_id>'. Refresh the browser before testing.",
      "expected": "Amber notification dot visible on Billing tab, matching sidebar dot color",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-mode-richselect-upgrade",
      "category": "Daemon Creation",
      "description": "Daemon mode dropdown shows clickable Upgrade tag on DaemonPoll for Free plan with descriptions",
      "steps": [
        "Open the daemon creation modal",
        "Open the Mode dropdown — it should be a rich dropdown, not a native select",
        "Verify ServerPoll is selectable and shows description text underneath the label",
        "Verify DaemonPoll shows a yellow 'Upgrade' tag with an arrow icon and description text",
        "Click on the DaemonPoll option (even though it's grayed out) — verify the billing plan modal opens",
        "Close the billing plan modal and verify you're back on the daemon creation form"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one network exists.",
      "expected": "RichSelect dropdown with descriptions on both options, yellow Upgrade tag on DaemonPoll, clicking DaemonPoll opens billing modal",
      "status": null,
      "feedback": null
    },
    {
      "id": "api-keys-tab-free-plan",
      "category": "Settings",
      "description": "API Keys tab shows upgrade message with clickable View Plans button, no Create button",
      "steps": [
        "Navigate to the API Keys tab",
        "Verify no 'Create' button is shown in the upper right corner",
        "Verify it shows an empty state message about API access not being available",
        "Click the 'View Plans' button in the empty state — verify the billing plan modal opens"
      ],
      "setup": "Org should be on the Free plan.",
      "expected": "No Create button, empty state with 'View Plans' CTA that opens billing modal",
      "status": null,
      "feedback": null
    },
    {
      "id": "discovery-upgrade-tag-clickable",
      "category": "Discovery",
      "description": "Scheduled discovery upgrade tag is clickable and opens billing modal",
      "steps": [
        "Open the discovery creation modal",
        "Open the Run Type dropdown",
        "Click on the Scheduled option (which shows Upgrade tag) — verify the billing plan modal opens",
        "Close the billing plan modal and verify you're back on the discovery form"
      ],
      "setup": "Org should be on the Free plan. Ensure at least one daemon exists.",
      "expected": "Clicking disabled Scheduled option opens billing plan modal",
      "status": null,
      "feedback": null
    },
    {
      "id": "upgrade-from-free-to-paid",
      "category": "Billing",
      "description": "Upgrade from Free plan to a paid plan via View Plans",
      "steps": [
        "Open Settings > Billing tab",
        "Verify current plan shows 'Free'",
        "Click 'View Plans'",
        "Select a paid plan (e.g., Starter) and click 'Start Free Trial' or 'Get Started'",
        "Complete Stripe checkout",
        "Verify redirect back to app",
        "Open Settings > Billing tab — verify the new plan name and 'Active' status are shown",
        "Verify 'Manage Subscription' button is now visible"
      ],
      "setup": "Org should be on the Free plan (default state after setup flow).",
      "expected": "Plan upgrades to paid plan, billing tab shows new plan name and Active status, Manage Subscription appears",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-to-free",
      "category": "Billing",
      "description": "Downgrade from paid plan to Free via Manage Subscription (Stripe portal)",
      "steps": [
        "Open Settings > Billing tab",
        "Verify current plan shows a paid plan (e.g., Starter)",
        "Click 'Manage Subscription' — verify redirect to Stripe customer portal",
        "In the portal, cancel the subscription",
        "Return to the app",
        "Open Settings > Billing tab — verify plan status reflects the cancellation"
      ],
      "setup": "Org should be on a paid plan with an active Stripe subscription.",
      "expected": "Stripe portal allows cancellation, app reflects canceled status after webhook processes",
      "status": null,
      "feedback": null
    },
    {
      "id": "daemon-poll-free-plan-interaction",
      "category": "Daemon",
      "description": "Existing DaemonPoll daemon behavior when org is on Free plan",
      "steps": [
        "Verify the daemon list shows the existing DaemonPoll daemon",
        "Check daemon status — verify the daemon is shown but may not connect (Free plan does not include DaemonPoll)",
        "Open Settings > Billing > View Plans and upgrade to a paid plan",
        "After upgrading, verify the DaemonPoll daemon can now connect and function"
      ],
      "setup": "Create a DaemonPoll daemon while on a paid plan: 1) Set org to paid plan: UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'active' WHERE id = '<org_id>'. 2) Create a daemon with mode=daemon_poll. 3) Downgrade to Free plan: UPDATE organizations SET plan = '{\"type\":\"Free\",\"base_cents\":0,\"rate\":\"Month\",\"trial_days\":0,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":3,\"included_hosts\":25}', plan_status = 'active' WHERE id = '<org_id>'. Refresh browser.",
      "expected": "DaemonPoll daemon visible but limited on Free plan, functional again after upgrading",
      "status": null,
      "feedback": null
    },
    {
      "id": "trial-ending-email",
      "category": "Emails",
      "description": "Trial ending soon email is sent when trial is about to expire",
      "steps": [
        "Check email inbox for trial-ending notification",
        "Verify the email contains: plan name, days remaining, link to add payment method",
        "Click the link in the email — verify it opens the app's billing settings"
      ],
      "setup": "Set org to trialing with trial ending in 3 days: UPDATE organizations SET plan = '{\"type\":\"Starter\",\"base_cents\":1500,\"rate\":\"Month\",\"trial_days\":7,\"seat_cents\":null,\"network_cents\":null,\"host_cents\":null,\"included_seats\":1,\"included_networks\":1,\"included_hosts\":100}', plan_status = 'trialing', trial_end_date = NOW() + INTERVAL '3 days', has_payment_method = false WHERE id = '<org_id>'. Trigger the trial notification check (may require waiting for cron or manual trigger).",
      "expected": "Email received with trial ending details and working link to billing settings",
      "status": null,
      "feedback": null
    },
    {
      "id": "downgrade-email",
      "category": "Emails",
      "description": "Email notification sent when subscription is canceled/downgraded",
      "steps": [
        "Check email inbox for downgrade/cancellation notification",
        "Verify the email mentions the plan change and any impact on features"
      ],
      "setup": "Cancel a paid subscription via Stripe portal (see downgrade-to-free test). Wait for webhook to process.",
      "expected": "Cancellation email received with plan change details",
      "status": null,
      "feedback": null
    }
  ]
}
