{
  "branch": "billing-overhaul",
  "tests": [
    {
      "id": "upgrade-after-auto-downgrade",
      "category": "Billing",
      "description": "After subscription expires and auto-downgrades to Free, upgrading to a paid plan routes through Stripe Checkout and succeeds",
      "steps": [
        "Open Settings > Billing > View Plans and select a paid plan (e.g., Team)",
        "Verify you are redirected to Stripe Checkout (not an instant switch or error)",
        "Complete Stripe Checkout with a test card",
        "Verify the app shows the paid plan as active with no errors",
        "Check Stripe dashboard — verify exactly one active subscription exists"
      ],
      "setup": "Org needs to be in the state after an end-of-cycle auto-downgrade to Free. Simulate this: have the org on a paid plan, then cancel the subscription in Stripe dashboard (or use Stripe CLI to advance the clock past the period end). Wait for the webhook to fire and confirm the org is now on Free plan with has_payment_method = false in the database.",
      "expected": "Upgrade routes through Stripe Checkout (collects payment). No 'resource_missing' or payment method errors. Plan activates successfully.",
      "status": null,
      "feedback": null
    },
    {
      "id": "payment-method-sync",
      "category": "Billing",
      "description": "Payment method status syncs from Stripe on subscription updates",
      "steps": [
        "Open Stripe dashboard and remove the default payment method from the customer",
        "Trigger a subscription update (e.g., switch plans via the billing portal)",
        "Open Settings > Billing — verify the 'Add Payment Method' card reappears"
      ],
      "setup": "Org should be on a paid plan with has_payment_method = true and a payment method in Stripe.",
      "expected": "Removing payment method in Stripe syncs to frontend state via webhook or portal action",
      "status": null,
      "feedback": null
    }
  ]
}
